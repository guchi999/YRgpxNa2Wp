<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åœ°åWPTå¤‰æ›</title>
  <style>
	body { width: 90%; max-width: 900px; min-width: 480px; margin: 0 auto; }
  </style>
</head>
<body>
	[ãƒ¤ãƒãƒ¬ã‚³åœ°åä»˜GPX åœ°åâ†’ã‚¦ã‚¨ã‚¤ãƒã‚¤ãƒ³ãƒˆå¤‰æ› V1.0]
	<br>
	<b>ç”»é¢ã«GPXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</b>
	<input type="file" multiple id="selfile">
	<br>
	<form name="entFil">
		<div>
			<label for="read_txt">å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆï¼§ï¼°ï¼¸ï¼‰</label> <br>
			<textarea name="read_txt" rows="10" cols="80" readonly></textarea><br>
		</div>
	</form>

	<form name="WpList">
		<div>
			<label for="WpList">åœ°å(ã‚¦ã‚¨ã‚¤ãƒã‚¤ãƒ³ãƒˆ)ãƒªã‚¹ãƒˆ</label> <br>
			<textarea name="wrt_txt" rows="10" cols="80" wrap=off  readonly></textarea><br>
		</div>
	</form>

	<form name="selbttn1">
		<span><b style="color:red">ğŸ›</b>åœ°å[ãµã‚ŠãŒãª]ãŒæœ‰ã‚Œã°ï¼š</span>
		<label><input type="radio" name="Ruby" value="on" onchange="make_Wplist_byYR(readTxt)"> å…¥ã‚Œã‚‹</label>
		<label><input type="radio" name="Ruby" value="off" onchange="make_Wplist_byYR(readTxt)" checked > å…¥ã‚Œãªã„</label>
	</form>

	<form name="selbttn2">
		<span><b style="color:red">ğŸ›</b>åœ°åãƒªãƒ³ã‚¯ãŒæœ‰ã‚Œã°ï¼š</span>
		<label><input type="radio" name="Link" value="on" onchange="make_Wplist_byYR(readTxt)" checked > å…¥ã‚Œã‚‹</label>
		<label><input type="radio" name="Link" value="off" onchange="make_Wplist_byYR(readTxt)" > å…¥ã‚Œãªã„</label>
	</form>

	<br>
	<a id="getLocal" href="#" onClick="saveFile()">
	<span style="border: 1px solid #000000; background-color: #dcdcdc">å¤‰æ›ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</span></a>
	<br><br>

<script>

var obj1 = document.getElementById("selfile");
var readTxt = ""; // å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—åˆ—
var writeFilNam = ""; // æ‹¡å¼µå­ç„¡ã—ãƒ•ã‚¡ã‚¤ãƒ«å
var writeTex = ""; // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç”¨æ–‡å­—åˆ—
var pointer = 0; // æ¤œç´¢ç”¨ãƒã‚¤ãƒ³ã‚¿
var trkpArr = [0, ""]; // trkptArr = [pointer, "lon,lat,ele"]
var flgErr1 = 1; // ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ©ã‚°
var WpList = {}; // ã‚¦ã‚¨ã‚¤ãƒã‚¤ãƒ³ãƒˆ(åœ°å)é…åˆ— { name; [ lat, lon, Link ], ... ]


//ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã‹ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ï¼‰
const dropArea = document.body; // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ã™ã‚‹é ˜åŸŸ
dropArea.addEventListener("dragover", event => {
	event.preventDefault();
	event.dataTransfer.dropEffect = "copy";
});
dropArea.addEventListener("drop", event => {
   event.preventDefault();
   var files = event.dataTransfer.files;
   getFiles(files);
});
function getFiles(files){
	for (let file of files){
		var reader = new FileReader();
		reader.readAsText(file); 
		reader.onload = event => {
			readTxt = event.target.result;
			writeFilNam = file.name.split(".")[0];
			after_file_read(readTxt, writeFilNam);
		}
	}
}
// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³å…¥åŠ›
var obj1 = document.getElementById("selfile");
obj1.addEventListener("change",function(evt){
	var file = evt.target.files;
  // ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’å–å¾—
	var input = document.querySelector("#selfile").files[0];
	var reader = new FileReader();  // FileReaderã®ä½œæˆ
	reader.readAsText(file[0]);  // ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§èª­ã¿è¾¼ã‚€
  // èª­è¾¼çµ‚äº†å¾Œ
	reader.onload = function(){
		readTxt = reader.result; // èª­ã¿è¾¼ã‚“ã ãƒ†ã‚­ã‚¹ãƒˆã‚’ readTxt ã«å…¥ã‚Œã‚‹
		writeFilNam = input.name.split( "." )[0];
		after_file_read(readTxt, writeFilNam);
	 }
},false);

function after_file_read(readTxt, writeFilNam){
	document.entFil.read_txt.value = readTxt;  //ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
	let fieChk = 0;
	pointer = readTxt.indexOf("</gpx>");
	( pointer !== -1 ) ? fieChk = fieChk: fieChk++;
	pointer = readTxt.indexOf("<gpx");
	( pointer !== -1 ) ? fieChk = fieChk: fieChk++;
	if (fieChk === 0 ){
		make_Wplist_byYR(readTxt);
		flgErr1 = 0;
	}else{
		alert("ãƒ•ã‚¡ã‚¤ãƒ«1ã¯GPXãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
		flgErr1 = 1;
	}
}

// æ›¸ãå‡ºã—ç”¨GPXè¨˜è¿°ï¼ˆ ãƒ˜ãƒƒãƒ€ + wptTxt + trk + <name>ã‚¿ã‚°å‰Šé™¤trktrkpt ï¼‰
function mke_write_txt() {
	pointer = readTxt.indexOf("<trk>");
	writeTex = readTxt.substring( 0, pointer );
	writeTex += mak_wptTxt();
	while ( pointer != -1 ){	
		pointer = readTxt.indexOf("<trk>", pointer);
		if ( pointer != -1 ){
			let pointer2 = readTxt.indexOf("<trkpt ", pointer);
			writeTex += readTxt.substring( pointer, pointer2 );
			let trkStr = readTxt.substring( pointer2, readTxt.indexOf("</trk>", pointer) );
			let pointer3, pointer4;
			while ( pointer3 != -1 ){
				pointer3 = trkStr.indexOf( "<trkpt ",  pointer3 );
				if ( pointer3 != -1 ){
					pointer4 = trkStr.indexOf("</trkpt>", pointer3);
					let trkptStr = trkStr.substring( pointer3, pointer4 + 8 );
					if ( trkptStr.indexOf("<name>") != -1 ){ trkptStr = trkptStr.split("<name>")[0] + "</trkpt>"; }
					writeTex += trkptStr + "\n";
					pointer3++;
				}else{
					writeTex += "</trkseg>\n</trk>\n";
					break;
				}
			}
			pointer++;
		}else{
			break;
		}
	}
	writeTex += "</gpx>\n";
}

// wtpè¨˜è¿°
function mak_wptTxt(){
	let wpTxt = "", wptName;
	for ( let keyName in WpList ){
		let wpData = WpList[ keyName ];
		wptName = keyName + wpData[3];
		wpTxt += `<wpt lat="${wpData[0]}" lon="${wpData[1]}" >\n`;
		wpTxt +=  `<name>${wptName}</name>\n<cmt>${wpData[4]}</cmt>\n`;
		wpTxt +=  `<desc>${wpData[2]}</desc>\n</wpt>\n`;
	}
	return wpTxt;
}

// ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
function saveFile() {
	if (flgErr1 == 1 ){ alert("æœ‰åŠ¹ãªGPXãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“"); return;}
	let title = writeFilNam + "_wp.gpx"; // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
	let linkTag = document.getElementById( "getLocal" );
	let linkTagAttr =  ["href","download"];
	let stringObject = new Blob( [writeTex], { type: "text/plain" } );
	let objectURL = window.URL.createObjectURL( stringObject );   
	linkTag.setAttribute( linkTagAttr[0], objectURL );
	linkTag.setAttribute( linkTagAttr[1], title ); 
}

// ãƒ¤ãƒãƒ¬ã‚³åœ°åä»˜GPXèª­ã¿è¾¼ã¿æ™‚ã®ãƒãƒ¼ã‚«ãƒ¼ãƒªã‚¹ãƒˆä½œæˆ
function make_Wplist_byYR(entStr){
	if (readTxt === "" ){ return; }
	WpList = {};	pointer = 0;	let nnn = 0;
	while ( nnn < 100 ){
		pointer = entStr.indexOf("<trkpt",pointer);
		if (pointer === -1){ break; }
		let trkptStr = entStr.substring(pointer, entStr.indexOf("</trkpt>",pointer)+8);
		if ( trkptStr.indexOf("<name>") != -1 ){
			let Latpt = trkptStr.indexOf("lat=");
			let Lonpt = trkptStr.indexOf("lon=");
			let strLat = trkptStr.substring( Latpt+5, trkptStr.indexOf('"', Latpt+5) );
			let strLon = trkptStr.substring( Lonpt+5, trkptStr.indexOf('"', Lonpt+5) );
			let strPLName = trkptStr.substring(trkptStr.indexOf("<name>")+6, trkptStr.indexOf("</name>"));
			let strName, strRuby, strLink;
			if ( strPLName.indexOf( "[" ) != -1 ){
				strName = strPLName.split(" ")[0]; 
				strRuby = strPLName.split(" ")[1]; 
			}else{
				strName = strPLName;
				 strRuby = "";
			}
			let strRuby2 = strRuby
			if ( strRuby2 != "" ){
				strRuby2 = strRuby2.replace("[", "");
				strRuby2 = strRuby2.replace("]", "");
			}
			(document.selbttn1.Ruby.value === "off" ) ?  strRuby = "":  strRuby = strRuby;
			( trkptStr.indexOf( "<link>" ) != -1 ) ? strLink = trkptStr.substring(trkptStr.indexOf("<link>")+6, trkptStr.indexOf("</link>")): strLink = "";
			(document.selbttn2.Link.value === "off" ) ?  strLink = "":  strLink = strLink;
			let dupNameFlg = 0;
		 	for (let keyName in WpList ){ if ( keyName ===  strName ){ dupNameFlg = 1; } }
			if ( dupNameFlg === 0 ){ 
				WpList[ strName ] = [strLat, strLon, strLink, strRuby, strRuby2];
			}
			nnn++;
		}
		pointer ++;
	}
	let wpTxt = "";
	for ( let keyName in WpList ){
		let wpData = WpList[ keyName ];
		wpTxt += keyName + wpData[3] + " (" + wpData[0] +", " + wpData[1] +") " + wpData[2] +"\n"
	}
	document.WpList.wrt_txt.value = wpTxt;  //ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
mke_write_txt();
}


</script>
</body>
</html>
